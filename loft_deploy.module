<?php
/**
 * @file
 * Base module file for loft_deploy
 *
 * @defgroup loft_deploy Loft Deploy
 * @{
 */

/**
 * @var LOFT_DEPLOY_SITE_ROLE
 */
define('LOFT_DEPLOY_SITE_ROLE', 'prod');
/**
 * @var LOFT_DEPLOY_SITE_ROLE_PROD
 */
define('LOFT_DEPLOY_SITE_ROLE_PROD', 'prod');
/**
 * @var LOFT_DEPLOY_SITE_ROLE_STAGING
 */
define('LOFT_DEPLOY_SITE_ROLE_STAGING', 'staging');
/**
 * @var LOFT_DEPLOY_SITE_ROLE_DEV
 */
define('LOFT_DEPLOY_SITE_ROLE_DEV', 'dev');

/**
 * Implements hook_init().
 */
function loft_deploy_init() {
  if (loft_deploy_site_role() !== LOFT_DEPLOY_SITE_ROLE_PROD) {
    drupal_add_css(drupal_get_path('module', 'loft_deploy') . '/loft_deploy.css');
    drupal_add_js(drupal_get_path('module', 'loft_deploy') . '/loft_deploy.js');
  }
}

/**
 * Get the site role as defined in settings.local.php
 */
function loft_deploy_site_role() {
  static $site_role = NULL;
  if ($site_role === NULL) {
    if (!($site_role = variable_get('loft_deploy_site_role', NULL))) {
      if (file_exists(DRUPAL_ROOT . '/' . conf_path() . '/settings.local.php')
        && ($file = file_get_contents(DRUPAL_ROOT . '/' . conf_path() . '/settings.local.php'))
        && preg_match('/\$site_role *\= *[\'"]{1}([^\'"]*)[\'"]{1}/', $file, $found)
        && ($site_role = $found[1])) {
      return $site_role;
      }
      else {
        // The default role is prod
        $site_role = LOFT_DEPLOY_SITE_ROLE_PROD;
      }
    }
  }
  return $site_role;
}

/**
 * Implements hook_preprocess_html().
 */
function loft_deploy_preprocess_html(&$vars) {
  if (($site_role = loft_deploy_site_role()) !== LOFT_DEPLOY_SITE_ROLE_PROD) {
    $output = '';
    $output .= <<<EOD
<div class="loft-deploy {$site_role}">
  <a class="hide" href="#">
  {$site_role}
  </a>
  <!-- Borders. -->
  <div class="border n"></div>
  <div class="border e"></div>
  <div class="border s"></div>
  <div class="border w"></div>
  </div>
EOD;

    $vars['page']['page_bottom']['loft_deploy_border'] = array(
      '#markup' => $output,
    );
  }
}
