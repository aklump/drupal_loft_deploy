<?php

/**
 * @file
 * Base module file for loft_deploy.
 *
 * @defgroup loft_deploy Loft Deploy
 * @{
 */

/**
 * Defines a prod environment.
 *
 * @var LOFT_DEPLOY_SITE_ROLE_PROD
 *
 * @deprecated Use LoftDeployManager::ROLE_PROD
 */
define('LOFT_DEPLOY_SITE_ROLE_PROD', LoftDeployManager::ROLE_PROD);

/**
 * Defines a staging environment.
 *
 * @var LOFT_DEPLOY_SITE_ROLE_STAGING
 *
 * @deprecated Use LoftDeployManager::ROLE_STAGING
 */
define('LOFT_DEPLOY_SITE_ROLE_STAGING', LoftDeployManager::ROLE_STAGING);

/**
 * Defines a dev environment.
 *
 * @var LOFT_DEPLOY_SITE_ROLE_DEV
 *
 * @deprecated Use LoftDeployManager::ROLE_DEV
 */
define('LOFT_DEPLOY_SITE_ROLE_DEV', LoftDeployManager::ROLE_DEV);

/**
 * Used to set the full path to the git binary.
 */
define('LOFT_DEPLOY_WHICH_GIT', 'git');

/**
 * @var LOFT_DEPLOY_META_TIMEOUT
 *
 * Default number of seconds for the meta key timeout.
 */
define('LOFT_DEPLOY_META_TIMEOUT', 600);

/**
 * Register module to be available in boot_invocations.
 */
function loft_deploy_boot() {
  // Simply defined so it gets discovered by Drupal.  Keep here.
}

/**
 * Return a service instance.
 *
 * @return \Drupal\loft_deploy\LoftDeployManager
 *   A shared instance.
 */
function loft_deploy_manager() {
  static $manager;
  if (!isset($manager)) {
    $manager = new \LoftDeployManager();
  }

  return $manager;
}

/**
 * Return the site role.
 *
 * @return string
 *   One of 'prod', 'staging', 'dev'
 *
 * @deprecated Use loft_deploy_manager()->getSiteRole().
 */
function loft_deploy_site_role() {
  return loft_deploy_manager()->getSiteRole();
}

/**
 * Return the GIT branch.
 *
 * @deprecated Use loft_deploy_manager()->getGitBranch().
 */
function loft_deploy_git_branch() {
  return loft_deploy_manager()->getGitBranch();
}

/**
 * Get the title string after replacements.
 *
 * DO NOT CACHE THIS OR IT WON'T RESPOND TO GIT CHANGES!
 *
 * @return string
 *   The title to use.
 *
 * @deprecated Use loft_deploy_manager()->getBorderTitle().
 */
function loft_deploy_get_title() {
  return loft_deploy_manager()->getBorderTitle();
}

/**
 * Determine if the current user should see the border.
 *
 * @return bool
 *   True if the current user should see the border.
 */
function loft_deploy_border_access() {
  static $drupal_static_fast;
  if (!isset($drupal_static_fast)) {
    $drupal_static_fast['access'] = &drupal_static(__FUNCTION__, NULL);
  }
  $access = &$drupal_static_fast['access'];
  if (is_null($access)) {
    $access = ($site_role = loft_deploy_manager()->getSiteRole()) !== LoftDeployManager::ROLE_PROD
      && empty($_COOKIE['loft_deploy']);
    drupal_alter('loft_deploy_border_access', $access, $site_role, $_COOKIE['loft_deploy']);
  }

  return $access && variable_get('loft_deploy_border', TRUE);
}

/**
 * Implements hook_preprocess_html().
 */
function loft_deploy_preprocess_html(&$vars) {
  if (loft_deploy_border_access()) {
    $ldm = loft_deploy_manager();
    $site_role = loft_deploy_manager()->getSiteRole();
    $output = '';

    $wrapper_attributes = array(
      'class' => array(
        'loft-deploy',
        $site_role,
      ),
    );
    if ($css = trim(variable_get('loft_deploy_css_class', ''))) {
      $wrapper_attributes['class'] = explode(' ', $css);
    }

    drupal_add_js(array(
      'loftDeploy' => array(
        'metaTimeout' => variable_get('loft_deploy_meta_timeout', LOFT_DEPLOY_META_TIMEOUT),
      ),
    ), 'setting');

    // Add in css class for the IP.
    if (($ip = ip_address())) {
      if (in_array($ip, array('127.0.0.1', '::1'))) {
        $ip = 'localhost';
      }
      else {
        $ip = 'ip-' . str_replace('.', '-', $ip);
      }
      $wrapper_attributes['class'][] = $ip;
    }

    if ($git_branch = $ldm->getGitBranch()) {
      $git_branch = strtolower($git_branch);
      $wrapper_attributes['class'][] = 'git-' . $git_branch;

      // Gitflow support.
      if (strpos($git_branch, 'master') === 0
        || strpos($git_branch, 'hotfix') === 0
      ) {
        $wrapper_attributes['class'][] = 'gitflow-master';
      }
      elseif (strpos($git_branch, 'develop') === 0
        || strpos($git_branch, 'release') === 0
      ) {
        $wrapper_attributes['class'][] = 'gitflow-develop';
      }
      elseif (strpos($git_branch, 'feature') === 0) {
        $wrapper_attributes['class'][] = 'gitflow-feature';
      }
    }

    // Add in some styles based on color settings in $conf.
    $style = array();
    if (($border_color = variable_get('loft_deploy_border_color', NULL))) {
      $style[] = 'background-color: ' . check_plain($border_color);
    }
    if (($title_color = variable_get('loft_deploy_title_color', NULL))) {
      $style[] = 'color: ' . check_plain($title_color);
    }
    if ($style) {
      $style = implode('; ', $style);
      $style = drupal_attributes(array('style' => $style));
    }
    else {
      $style = '';
    }
    array_walk($wrapper_attributes['class'], function ($item) {
      return 'loft_deploy--' . $item;
    });

    // Prepare vars for tpl.
    $wrapper_attributes = drupal_attributes($wrapper_attributes);
    $title = $ldm->getBorderTitle();

    $output .= <<<EOD
<div{$wrapper_attributes}">
  <a class="js-loft-deploy__hide" href="#"{$style}>
  <span class="loft-deploy__title">{$title}</span>
  </a>
  <!-- Borders. -->
  <div class="loft-deploy__border--n"{$style}></div>
  <div class="loft-deploy__border--e"{$style}></div>
  <div class="loft-deploy__border--s"{$style}></div>
  <div class="loft-deploy__border--w"{$style}></div>
  </div>
EOD;

    $vars['page']['page_bottom']['loft_deploy_border'] = array(
      '#markup' => $output,
      '#attached' => array(
        'css' => array(
          drupal_get_path('module', 'loft_deploy') . '/loft_deploy.css',
        ),
        'library' => array(
          array('system', 'cookie'),
        ),
      ),
    );

    $vars['page']['page_bottom']['loft_deploy_border']['#attached']['js'][] = array(
      'type' => 'file',
      'scope' => 'footer',
      'group' => JS_THEME,
      'data' => drupal_get_path('module', 'loft_deploy') . '/loft_deploy.js',
    );
  }
}
